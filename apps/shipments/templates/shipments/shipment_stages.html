{% extends 'base.html' %}
{% load static %}
{% block content %}
{% load crispy_forms_tags %}
  <h2>Shipment {{ shipment.pk }}</h2>

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <h4>Dados Finais</h4>
    {% crispy final_form %}

    {{ stages_fs.management_form }}

    {# ───────────── FINAL SHIPMENT ───────────── #}
    <h5 class="mt-5">Checklist Final</h5>
    <div class="accordion mb-4" id="finalStagesAccordion">
      {% for sf in stages_fs.forms %}
        {% if sf.instance.stage.workflow == 'SHP' %}
          <div class="accordion-item">
            {% for h in sf.hidden_fields %}{{ h }}{% endfor %}
            <h2 class="accordion-header" id="head-final{{ forloop.counter }}">
              <button class="accordion-button collapsed" type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#body-final{{ forloop.counter }}">
                {{ sf.instance.stage.name }}
              </button>
            </h2>
            <div id="body-final{{ forloop.counter }}"
                class="accordion-collapse collapse"
                data-bs-parent="#finalStagesAccordion">
              <div class="accordion-body row g-3">
                {% for fld in sf.visible_fields %}
                  <div class="col-md-4">
                    {{ fld.label_tag }} {{ fld }} {{ fld.errors }}
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>

    {# ───────────── PRÉ-EMBARQUE ───────────── #}
    <h5 class="mt-4">Checklist Pré-Embarque</h5>
    <div class="accordion mb-4" id="preStagesAccordion">
      {% for sf in stages_fs.forms %}
        {% if sf.instance.stage.workflow == 'PRE' %}
          <div class="accordion-item">
            {% for h in sf.hidden_fields %}{{ h }}{% endfor %}
            <h2 class="accordion-header" id="head-pre{{ forloop.counter }}">
              <button class="accordion-button collapsed" type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#body-pre{{ forloop.counter }}">
                {{ sf.instance.stage.name }}
              </button>
            </h2>
            <div id="body-pre{{ forloop.counter }}"
                class="accordion-collapse collapse"
                data-bs-parent="#preStagesAccordion">
              <div class="accordion-body row g-3">
                {% for fld in sf.visible_fields %}
                  <div class="col-md-4">
                    {{ fld.label_tag }} {{ fld }} {{ fld.errors }}
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>



    <div class="mt-3">
      <button class="btn btn-success">Salvar Final Shipment</button>
      <a href="{% url 'shipments:shipment-detail' shipment.pk %}"
         class="btn btn-secondary">Cancelar</a>
    </div>
  </form>

{% endblock %}

{% extends 'base.html' %}
{% load static %}
{% load pagination_tags %}
{% load crispy_forms_tags %}

{% block title %}
  {% if object %}Order #{{ object.pk }}{% else %}New Order{% endif %}
{% endblock %}

{% block content %}
<div class="container my-4">
  <!-- Page Header -->
  <div class="card shadow-sm mb-4">
    <div class="card-body d-flex justify-content-between align-items-center">
      <div>
        <h3 class="mb-0">{% if object %}Order #{{ object.pk }}{% else %}New Order{% endif %}</h3>
        <small class="text-muted">{% if object %}Generated on {{ object.created_at|date:"F j, Y" }}{% endif %}</small>
      </div>
      <div class="btn-group">
        {% if object.proforma %}
          {% if object.proforma.pdf %}
            <a href="{% url 'finance:proforma-detail' object.proforma.pk %}" class="btn btn-outline-warning btn-sm">
              <i class="bi bi-file-earmark-text"></i> View Proforma
            </a>
          {% endif %}
        {% elif object and not object.is_locked %}
          <a href="{% url 'finance:proforma-create' object.pk %}" class="btn btn-secondary btn-sm">
            <i class="bi bi-file-plus"></i> Create Proforma
          </a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Summary Cards -->
  {% if object %}
  <div class="row gx-3 mb-4">
    <div class="col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h6 class="mb-3">Order Details</h6>
          <p class="mb-2"><strong>Customer:</strong> {{ object.customer }}</p>
          <p class="mb-2"><strong>Company:</strong> {{ object.company }}</p>
          <p class="mb-2"><strong>Importer:</strong> {{ object.exporter }}</p>
          <p class="mb-2"><strong>Exporter:</strong> {{ object.exporter }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h6 class="text-success mb-2">Shipping</h6>
          <p class="mb-2"><strong>Port Loading:</strong> {{ object.pol }}</p>
          <p class="mb-2"><strong>Port Discharge:</strong> {{ object.pod }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h6 class="mb-2">Payment</h6>
          <p class="mb-2"><strong>Down Payment:</strong> {{ object.down_payment }}%</p>
          <p class="h5 mb-2">$ {{ order_metrics.deposit_payment }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h6 class="text-success mb-2">Order Total USD</h6>
          <p class="h5 mb-0">$ {{ order_metrics.total_selling_price|default:"0.00" }}</p>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Order Form -->
  <form method="post" id="order-form" novalidate>
    {% csrf_token %}
    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {{ form.non_field_errors|join:' ' }}
      </div>
    {% endif %}
    
    {% if not object.is_locked %}  
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white border-0">
          <h5 class="mb-0">Order Information</h5>
        </div>
        <div class="card-body">
          {% crispy form %}
        </div>
      </div>
    {% endif %}

    <!-- Batches Section -->
    {% if object %}
    <div class="card shadow-sm mb-4">
      <div class="card-header d-flex justify-content-between align-items-center bg-white border-0">
        <h5 class="mb-0">Order Batches</h5>
        <a href="{% url 'orders:batch-add' object.pk %}" class="btn btn-sm btn-success">
          <i class="bi bi-plus-lg"></i> New Batch
        </a>
      </div>
      <div class="card-body p-0">
        {% if object.batches.exists %}
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <thead class="table-light">
              <tr>
                <th>Code</th><th>Status</th><th>Created</th><th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for batch in object.batches.all %}
              <tr>
                <td>{{ batch.batch_code }}</td>
                <td>{{ batch.get_status_display }}</td>
                <td>{{ batch.created_at|date:"d/m/Y H:i" }}</td>
                <td>
                  <a href="{% url 'orders:order-batch-list' object.pk %}" class="btn btn-sm btn-outline-primary">View</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="alert alert-info mb-0 text-center p-3">No batches created.</div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <!-- Items Section -->
    {{ items_formset.management_form }}
    <input type="hidden" name="page" value="{{ items_page.number }}">
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
          {{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}

    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center bg-white border-0">
        <h5 class="mb-0">Order Items</h5>
        <div class="ms-auto d-flex gap-2">
          {% if object and not object.is_locked %}
            <button
              id="btn-update-margins"
              type="button"
              class="btn btn-warning btn-sm"
              data-update-url="{% url 'orders:order-update-margins' object.pk %}"
            >
              <i class="bi bi-arrow-clockwise"></i> Update Margins
            </button>
            <button
              id="btn-import-items"
              type="button"
              class="btn btn-outline-primary btn-sm"
              data-url="{% url 'orders:order-item-import' object.pk %}"
            >
              <i class="bi bi-upload"></i> Import Items
            </button>
          {% elif not object.is_locked %}
            <button
              type="button"
              id="btn-import-items-new"
              class="btn btn-outline-primary float-end"
              data-url="{% url 'orders:order-item-import-new' %}"
            >
              <i class="bi bi-upload"></i> Import Items
            </button>
          {% endif %}
        </div>
      </div>
      <div class="card-body p-0">
        {% if items_formset.non_form_errors %}
        <div class="alert alert-danger m-3">{{ items_formset.non_form_errors|join:' ' }}</div>
        {% endif %}
        <div class="table-responsive">
          <table class="table table-striped table-sm mb-0">
            <thead class="table-responsive">
              <tr>
                <th>Item</th><th>Cost</th><th>USD Cost</th><th>Margin</th><th>Sale</th><th>Qty</th><th>Orig</th><th>Bal</th>{% if not object.is_locked %}<th>Actions</th>{% endif %}
              </tr>
            </thead>
            <tbody id="items-grid">
              {% for subform in items_formset %}
              <tr class="align-middle">
                {% for hidden in subform.hidden_fields %}{{ hidden }}{% endfor %}
                <td>{{ subform.item }}</td>
                <td><small>{{ subform.instance.cost_price }}</small></td>
                <td><small>{{ subform.instance.cost_price_usd }}</small></td>
                <td>{{ subform.margin }}</td>
                <td><small>{{ subform.instance.sale_price }}</small></td>
                <td>{{ subform.quantity }}</td>
                <td><small>{% if subform.instance.pk %}{{ subform.instance.quantity }}{% else %}&mdash;{% endif %}</small></td>
                <td><small>{% if subform.instance.pk %}{{ subform.instance.remaining_qty }}{% else %}&mdash;{% endif %}</small></td>
                {% if subform.instance.pk and not object.is_locked %}
                    <td>
                      {{ subform.DELETE }} <small>Delete</small>
                  {% elif not object.is_locked %}
                      <button type="button" class="btn btn-sm btn-danger remove-row">
                        Remove
                      </button>
                    
                    </td>
                  {% endif %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% if not object.is_locked %}
      <div class="card-footer bg-white border-top-0 ">
        <button type="button" id="add-item" class="btn btn-primary btn-sm">
          <i class="bi bi-plus-lg"></i> Add Item
        </button>
      </div>
      {% endif %}
    </div>
    <div class="mt-3 mb-4">
      {% render_pagination items_page %}
    </div>
    <!-- Form Actions -->
    <div class="d-flex justify-content-end mt-4 mb-4">
      <button type="submit" name="action" value="save_exit" class="btn btn-success me-2">Save & Exit</button>
      <button type="submit" name="action" value="save_continue" class="btn btn-outline-primary">Save & Continue</button>
    </div>
  </form>

</div>
<form id="import-form" 
      method="post" 
      action="{% url 'orders:order-item-import-new' %}" 
      style="display:none;">
  {% csrf_token %}
  <input type="hidden" name="customer" id="import-customer">
  <input type="hidden" name="exporter" id="import-exporter">
  <input type="hidden" name="company"  id="import-company">
</form>

{# ——— Template oculto para clonagem ——— #}
<table class="d-none">
  <tbody>
    <tr id="empty-form-template" class="item-row align-middle">
      {% for hidden in items_formset.empty_form.hidden_fields %}
        {{ hidden }}
      {% endfor %}
      <td>{{ items_formset.empty_form.item }}</td>
      <td>
        <small>{{ items_formset.empty_form.cost_price|default:"0.00" }}</small>
      </td>
      <td>
        <small>
          $&nbsp;&nbsp;&nbsp{{ items_formset.empty_form.cost_price_usd|default:"0.00" }}
        </small>
      </td>
      <td>{{ items_formset.empty_form.margin }}</td>
      <td>
        <small>
          $&nbsp;&nbsp;&nbsp{{ items_formset.empty_form.sale_price|default:"0.00" }}
        </small>
      </td>
      <td>{{ items_formset.empty_form.quantity }}</td>
      <td>&mdash;</td>
      <td>&mdash;</td>
      <td>
        <button type="button" class="btn btn-sm btn-danger remove-row">
          Remove
        </button>
      </td>
    </tr>
  </tbody>
</table>
{% endblock %}

{% block scripts %}
  <script src="{% static 'js/order_formsets.js' %}"></script>
  <script src="{% static 'js/import_order_itens.js' %}"></script>
{% endblock %}
